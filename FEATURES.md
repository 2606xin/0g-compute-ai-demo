# 新增功能说明

本文档介绍在基础 0G Broker Starter Kit 之上新增的功能特性。

## 目录

- [币安 API 集成](#币安-api-集成)
- [智能交易对识别](#智能交易对识别)
- [价格信息确认机制](#价格信息确认机制)
- [Markdown 消息渲染](#markdown-消息渲染)
- [Provider 余额管理](#provider-余额管理)
- [优化的用户界面](#优化的用户界面)
- [增强的错误处理](#增强的错误处理)

---

## 币安 API 集成

### 功能描述

AI 聊天功能现已集成币安期货 API，可以实时获取加密货币价格数据，并基于这些数据提供交易建议。

### 技术实现

- **API 端点**: `https://fapi.binance.com/fapi/v1/ticker/price`
- **支持批量查询**: 可同时查询多个交易对的价格
- **自动降级**: 批量查询失败时自动切换到单个查询
- **超时保护**: 5 秒超时机制，避免长时间等待

### 使用示例

```
用户输入: "给我一些关于 BTCUSDT 的交易建议"
系统自动:
1. 检测到交易对 BTCUSDT
2. 从币安获取最新价格
3. 将价格数据作为上下文提供给 AI
4. AI 基于实时价格给出交易建议
```

---

## 智能交易对识别

### 功能描述

系统能够智能识别用户消息中的交易对，支持多种输入格式。

### 支持的格式

1. **完整交易对格式**

   - `BTCUSDT`
   - `BTC/USDT`
   - `BTC-USDT`
   - `BTC USDT`

2. **币种名称映射**

   - 单个币种代码: `btc` → `BTCUSDT`
   - 全名: `bitcoin` → `BTCUSDT`
   - 支持大小写: `BTC`、`btc`、`Bitcoin` 均可识别

3. **支持的币种**

   **主流币种:**

   - BTC (Bitcoin)
   - ETH (Ethereum)
   - BNB (Binance Coin)
   - SOL (Solana)
   - ADA (Cardano)
   - DOGE (Dogecoin)
   - XRP (Ripple)
   - DOT (Polkadot)
   - MATIC (Polygon)
   - AVAX (Avalanche)
   - LINK (Chainlink)
   - UNI (Uniswap)
   - LTC (Litecoin)
   - ATOM (Cosmos)
   - 更多...

   **0G 相关:**

   - `0g` → `0GUSDT`
   - `zg` → `0GUSDT`
   - `0glabs` → `0GUSDT`

### 识别逻辑

系统使用三层识别机制：

1. **正则表达式匹配**: 识别完整交易对格式
2. **币种名称映射**: 识别单个币种名称并转换为标准交易对
3. **独立代码匹配**: 识别文本中的币种代码

---

## 价格信息确认机制

### 功能描述

在发送消息给 AI 之前，系统会先检测交易对并获取价格信息，让用户确认后再发送。

### 工作流程

1. **用户输入消息** → 点击"发送"
2. **系统检测交易对** → 自动识别消息中的交易对
3. **获取价格数据** → 从币安 API 获取最新价格
4. **显示确认界面** → 展示价格信息，等待用户确认
5. **用户选择**:
   - ✅ **确认并发送（包含价格）**: 将价格数据作为上下文发送给 AI
   - ⏭️ **直接发送（不包含价格）**: 忽略价格数据，直接发送原始消息
   - ❌ **取消**: 取消操作，恢复输入框

### 确认界面显示内容

- **待发送消息**: 显示用户输入的消息内容
- **检测到的交易对**: 以标签形式显示所有检测到的交易对
- **价格信息**: 格式化显示每个交易对的最新价格
- **错误提示**: 如果价格获取失败，显示具体错误信息

### 优势

- ✅ 用户可以在发送前查看价格数据
- ✅ 可以选择是否使用价格数据
- ✅ 价格获取失败不影响正常聊天
- ✅ 提供清晰的视觉反馈

---

## Markdown 消息渲染

### 功能描述

AI 返回的消息现在支持完整的 Markdown 渲染，包括表格、代码块、列表等，大大提升了可读性。

### 支持的 Markdown 特性

1. **表格**

   - 完整的表格样式（边框、表头、单元格）
   - 响应式设计，支持横向滚动
   - 清晰的视觉层次

2. **代码块**

   - 行内代码: 浅灰背景，粉色文字
   - 代码块: 深色背景，等宽字体，支持横向滚动

3. **引用块**

   - 左侧蓝色边框
   - 浅灰背景
   - 斜体文字

4. **标题**

   - 支持 H1-H6 多级标题
   - 不同层级有不同字体大小和间距

5. **列表**

   - 有序列表和无序列表
   - 合适的缩进和间距

6. **其他**
   - 分隔线
   - 强调文本（粗体、斜体）
   - 段落间距优化

### 技术实现

- 使用 `react-markdown` 库进行 Markdown 渲染
- 使用 `remark-gfm` 插件支持 GitHub Flavored Markdown
- 自定义组件样式，确保美观和一致性

---

## Provider 余额管理

### 功能描述

在"服务"标签页中，现在可以查看每个 Provider 的 inference 子账户余额，并支持直接充值。

### 主要功能

1. **余额查询**

   - 自动查询所有 Provider 的余额
   - 在下拉选择框中显示余额信息
   - 支持手动刷新余额

2. **余额显示**

   - 每个 Provider 显示其 inference 子账户余额
   - 格式: `Provider名称 - 模型 (余额: X.XXXX A0GI)`
   - 选中 Provider 后显示详细余额信息

3. **余额充值**
   - 为选中的 Provider 充值
   - 从主账本转账到 inference 子账户
   - 充值后自动刷新余额显示
   - 显示充值状态和结果

### 使用流程

1. 进入"服务"标签页
2. 系统自动显示所有 Provider 的余额
3. 选择需要充值的 Provider
4. 输入充值金额
5. 点击"充值"按钮
6. 等待交易确认
7. 余额自动更新

### 注意事项

- 确保主账本有足够的余额
- 充值金额以 A0GI 为单位
- 充值需要等待区块链交易确认（约 2 秒）

---

## 优化的用户界面

### 聊天界面优化

1. **对话窗口**

   - 高度从 300px 增加到 `calc(100vh - 450px)`
   - 最小高度 500px，最大高度 700px
   - 响应式设计，适应不同屏幕尺寸

2. **整体布局**

   - 聊天标签页时容器宽度增加到 1200px
   - 使用 Flexbox 布局，支持自适应高度
   - 优化间距和 padding

3. **消息显示**

   - 消息间距增加到 20px
   - AI 消息使用白色卡片背景，添加阴影效果
   - 用户和 AI 消息使用不同颜色的头像标识

4. **输入区域**
   - 输入框 padding 增加到 12px 15px
   - 按钮样式优化，添加禁用状态
   - 改善视觉层次

### 视觉改进

- ✅ 统一的圆角样式（8px）
- ✅ 更好的颜色对比度
- ✅ 清晰的视觉层次
- ✅ 响应式设计

---

## 增强的错误处理

### 功能描述

改进了错误处理机制，提供更详细的错误信息和更好的用户体验。

### 改进内容

1. **API 错误处理**

   - 检查 HTTP 响应状态
   - 验证响应数据格式
   - 提供详细的错误信息

2. **余额检查**

   - 自动检测余额不足情况
   - 自动充值机制
   - 余额为 0 时的特殊处理

3. **价格获取错误**

   - 价格获取失败不影响正常聊天
   - 显示具体错误信息
   - 支持重试机制

4. **用户提示**
   - 所有操作都有状态提示
   - 成功/失败消息清晰显示
   - 加载状态可视化

---

## 技术栈更新

### 新增依赖

```json
{
  "react-markdown": "^10.1.0",
  "remark-gfm": "^4.0.1"
}
```

### 代码改进

- ✅ TypeScript 类型定义完善
- ✅ 组件结构优化
- ✅ 代码可维护性提升

---

## 使用示例

### 示例 1: 查询单个币种价格

```
用户输入: "btc 现在的价格是多少？"
系统:
1. 检测到 "btc" → 映射为 BTCUSDT
2. 获取 BTCUSDT 价格
3. 显示确认界面
4. 用户确认后，AI 基于实时价格回答
```

### 示例 2: 查询多个币种

```
用户输入: "查看 BTC 和 ETH 的价格，给我交易建议"
系统:
1. 检测到 BTC 和 ETH
2. 获取 BTCUSDT 和 ETHUSDT 价格
3. 显示两个交易对的价格
4. AI 基于实时价格给出交易建议
```

### 示例 3: 使用完整交易对

```
用户输入: "BTCUSDT 和 ETH/USDT 的交易建议"
系统:
1. 检测到 BTCUSDT 和 ETHUSDT
2. 获取两个交易对的价格
3. AI 提供基于实时数据的交易建议
```

---

## 注意事项

1. **网络要求**: 需要能够访问币安 API (`fapi.binance.com`)
2. **API 限制**: 币安 API 有请求频率限制，请合理使用
3. **价格延迟**: 价格数据可能有轻微延迟，仅供参考
4. **交易建议**: AI 提供的交易建议仅供参考，不构成投资建议

---

## 未来计划

- [ ] 支持更多交易所 API
- [ ] 价格历史数据展示
- [ ] 交易对价格对比
- [ ] 更多技术指标分析
- [ ] 价格预警功能

---

## 更新日志

### v1.1.0 (最新)

- ✨ 新增币安 API 集成
- ✨ 新增智能交易对识别
- ✨ 新增价格信息确认机制
- ✨ 新增 Markdown 消息渲染
- ✨ 新增 Provider 余额管理
- 🎨 优化用户界面样式
- 🐛 改进错误处理机制

---

## 相关资源

- [币安期货 API 文档](https://binance-docs.github.io/apidocs/futures/cn/)
- [React Markdown 文档](https://github.com/remarkjs/react-markdown)
- [0G Labs 文档](https://docs.0g.ai)
